generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

// === TABLES === //

model Restaurant {
  id         Int            @id @default(autoincrement())
  name       String
  categories DishCategory[]
  orders     Order[]

  @@map("restaurant")
  @@schema("public")
}

model DishCategory {
  id           Int        @id @default(autoincrement())
  priority     Int
  name         Json
  dishes       Dish[]
  picture      String? // URL of the picture
  restaurantId Int        @map("restaurant_id")
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("dish_category")
  @@schema("public")
}

model Dish {
  id            Int          @id @default(autoincrement())
  priority     Int
  name          Json
  price         Float
  picture       String? // URL of the picture
  categoryId    Int          @map("category_id")
  category      DishCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  ingredients   Json
  labels        Json?
  allergies     Json?
  nutritions    Json?
  dietType      DietType?
  description   Json?
  saleStartDate DateTime?    @map("sale_start_date")
  saleEndDate   DateTime?    @map("sale_end_date")
  salePrice     Float?       @map("sale_price")
  saleDays      Int[]        @map("sale_days") // 1..7, 1 = monday, 2 = tuesday...

  @@index([categoryId], type: BTree)
  @@map("dish")
  @@schema("public")
}

enum DietType {
  VEGAN
  VEGETARIAN
  PESCATARIAN
  OMNIVORE

  @@map("dish_type")
  @@schema("public")
}

model Allergy {
  id        Int      @id @default(autoincrement())
  name      Json     @unique
  allergens String[]

  @@map("allergy")
  @@schema("public")
}

model Nutrition {
  id      Int    @id @default(autoincrement())
  dish    String @unique // Unique dishes, not related to entity Dish
  energy  Int // Unit: kcal
  protein Int // Unit: grams

  @@map("nutrition")
  @@schema("public")
}

model Order {
  id            Int           @id @default(autoincrement())
  table         String
  positions     Json
  paymentMethod PaymentMethod @map("payment_method")
  isPayed       Boolean?      @map("is_payed")
  netTotal      Float         @map("net_total")
  vat           Float?
  note          String?
  restaurantId  Int           @map("restaurant_id")
  retaurant     Restaurant    @relation(fields: [restaurantId], references: [id])
  orderDate     DateTime?     @default(now()) @map("order_date") @db.Timestamp() // UTC

  @@map("order")
  @@schema("public")
}

enum PaymentMethod {
  CARD
  CASH
  COUPON

  @@map("payment_method")
  @@schema("public")
}
